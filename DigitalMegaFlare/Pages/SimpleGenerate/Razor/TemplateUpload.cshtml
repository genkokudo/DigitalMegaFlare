@page
@model DigitalMegaFlare.Pages.SimpleGenerate.Razor.TemplateUploadModel
@using Newtonsoft.Json;
@{
    ViewData["Title"] = "TemplateUpload";
    ViewData["RootList"] = Model.Data.Files[""];
}

<h2>Razorテンプレート開発改造室</h2>

<div class="form-group">
    <div class="row">
        <div class="col-4">
            <select id="SelectMainDirectory" asp-items="ViewBag.RootList" class="form-control">
                <option value="">----- 言語・ライブラリ -----</option>
            </select>
        </div>
        <div class="col-4">
            <select id="SelectSubDirectory" class="form-control">
                <option value="">----- 分類 -----</option>
            </select>
        </div>
        <div class="col-4">
            <select id="SelectFile" asp-for="FilePath" class="form-control">
                <option value="">----- ファイル -----</option>
            </select>
        </div>
    </div>

    <textarea id="TextArea" placeholder="Razorスクリプト" class="form-control" TextMode="multiline" rows="30" style="font-size: 12px;">@ViewData["Script"]</textarea>

    <form method="post">
        <button type="submit" class="btn btn-primary btn-sm">GOGO!</button>
    </form>
</div>

@section Scripts {
    <script>
        var _files = @Html.Raw(JsonConvert.SerializeObject(Model.Data.Files));

        // ページを全て読み込み終わった後に実行する
        $(window).on('load', function() {
        });

        $('#SelectMainDirectory').on('change', function () {
            if (this.value != '') {
                // 取り除く
                $('#SelectSubDirectory').children().remove();
                $('#SelectFile').children().remove();

                // 選択肢のセット
                $('#SelectSubDirectory').append('<option value="">----- 分類 -----</option>');
                $('#SelectFile').append('<option value="">----- ファイル -----</option>');
                _files[this.value].forEach((value) => {
                    $('#SelectSubDirectory').append('<option value="' + value.Value + '">' + value.Text + '</option>');
                });
            }
        });

        $('#SelectSubDirectory').on('change', function () {
            if (this.value != '') {
                // 取り除く
                $('#SelectFile').children().remove();
                $('#SelectFile').append('<option value="">----- ファイル -----</option>');
                
                // 選択肢のセット
                _files[this.value].forEach((value) => {
                    $('#SelectFile').append('<option value="' + value.Value + '">' + value.Text + '</option>');
                });
            }
        });

        $('#SelectFile').on('change', function () {

            var formData = new FormData();
            formData.append('filepath', this.value);

            $.ajax({
                type: 'POST',
                url: '/Razor/Load',
                contentType: false,
                processData: false,
                data: formData
            }).then(
                function (data) {
                    if (data != null && data.message != undefined) {
                        alert(data.message);
                        $('#TextArea').text(data.message);
                    }
                },
                function (data) {
                    alert('ファイルが取れなかった');
                }
            );

        });

    </script>
}
